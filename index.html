<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Crypto Mentions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 1100px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
    header { max-width: var(--maxw); margin: 0 auto 16px; }
    h1 { margin: 0 0 8px; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 8px 0 16px; }
    select, input[type="text"] { padding: 6px 8px; font-size: 14px; }
    .muted { color: #666; font-size: 12px; }
    .link { margin: 6px 0 12px; }
    main { max-width: var(--maxw); margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    caption { text-align: left; font-weight: 600; margin-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    canvas#mentions-chart {
      width: 100%;
      height: 600px; /* updated height */
    }

    /* Pikaday CSS */
    .pika-single { z-index: 9999; display: block; position: relative; color: #333; background: #fff; border: 1px solid #ccc; box-shadow: 0 1px 3px #bbb; border-radius: 3px; }
    .pika-single.is-hidden { display: none; }
    .pika-lendar { padding: 10px; }
    .pika-title { text-align: center; position: relative; margin-bottom: 10px; user-select: none; }
    .pika-label { font-weight: 700; font-size: 14px; }
    .pika-prev, .pika-next { cursor: pointer; position: absolute; top: 14px; width: 20px; height: 20px; line-height: 20px; text-align: center; font-size: 18px; color: #999; user-select: none; }
    .pika-prev:hover, .pika-next:hover { color: #000; }
    .pika-prev { left: 10px; }
    .pika-next { right: 10px; }
    .pika-table { width: 100%; border-collapse: collapse; border-spacing: 0; user-select: none; }
    .pika-table th, .pika-table td { width: 14.285714285714286%; padding: 5px 0; text-align: center; cursor: pointer; }
    .pika-table th { color: #999; font-weight: 700; font-size: 12px; }
    .pika-button { border: none; background: none; color: inherit; font: inherit; cursor: pointer; outline: none; }
    .is-disabled { color: #ccc !important; pointer-events: none; cursor: default; }
    .is-selected { background: #1f77b4; color: white; border-radius: 3px; }
    .is-today { color: #d33; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Daily Crypto Mentions</h1>
    <div class="controls">
      <label for="date-picker">Select date:</label>
      <input type="text" id="date-picker" aria-label="Select date" readonly />

      <label for="topn-select">Top N:</label>
      <select id="topn-select" aria-label="Select number of lines">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20" selected>20</option>
      </select>

      <span id="meta" class="muted"></span>
    </div>
    <div id="thread-link" class="link"></div>
  </header>

  <main>
    <div class="grid">
      <section>
        <table>
          <caption>Top coins by mentions (selected day)</caption>
          <thead>
            <tr><th style="width:80px">Symbol</th><th>Name</th><th style="width:120px">Mentions</th></tr>
          </thead>
          <tbody id="data-table"><tr><td colspan="3">Loadingâ€¦</td></tr></tbody>
        </table>
      </section>
      <section>
        <canvas id="mentions-chart"></canvas>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css" />

  <script>
  (function() {
    'use strict';

    const manifestUrl = 'manifest.json';
    const datePickerEl = document.getElementById('date-picker');
    const topNEl = document.getElementById('topn-select');
    const tbody = document.getElementById('data-table');
    const metaEl = document.getElementById('meta');
    const threadLinkEl = document.getElementById('thread-link');
    const ctx = document.getElementById('mentions-chart').getContext('2d');

    let manifestData = [];
    let dateToFileMap = {};
    let validDateStrs = [];
    let picker = null;
    let chartInstance = null;

    async function fetchJson(url) {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' for ' + url);
      return res.json();
    }

    function normalizeDayList(dayData) {
      let list = [];
      if (Array.isArray(dayData.results_list) && dayData.results_list.length) {
        list = dayData.results_list.map(r => ({
          symbol: (r.symbol || '').toUpperCase(),
          name: r.name || '',
          count: Number(r.count || 0)
        }));
      } else if (dayData.results && typeof dayData.results === 'object') {
        list = Object.entries(dayData.results).map(([k, v]) => ({
          symbol: (k || '').toUpperCase(),
          name: '',
          count: Number(v || 0)
        }));
      }
      list.sort((a, b) => b.count - a.count);
      return list;
    }

    function renderTable(list, limit = 100) {
      const rows = list.slice(0, limit).map(row => (
        `<tr><td>${row.symbol}</td><td>${row.name || ''}</td><td>${row.count}</td></tr>`
      )).join('');
      tbody.innerHTML = rows || '<tr><td colspan="3">No data</td></tr>';
    }

    function getPalette(n) {
      const base = [
        '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
        '#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf',
        '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f',
        '#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'
      ];
      const out = [];
      for (let i = 0; i < n; i++) out.push(base[i % base.length]);
      return out;
    }

    async function loadDayData(filePath, topN) {
      try {
        const dayData = await fetchJson(filePath);
        const list = normalizeDayList(dayData);

        const updated = dayData.generated_at_utc ? new Date(dayData.generated_at_utc).toISOString().replace('T',' ').replace('Z',' UTC') : '';
        threadLinkEl.innerHTML = dayData.thread_url
          ? `<a href="${dayData.thread_url}" target="_blank" rel="noopener">${dayData.thread_title || 'Thread link'}</a>`
          : (dayData.thread_title || '');
