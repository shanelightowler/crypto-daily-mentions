<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Crypto Mentions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --maxw: 1100px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; }
    header { max-width: var(--maxw); margin: 0 auto 16px; }
    h1 { margin: 0 0 8px; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; margin: 8px 0 16px; }
    select, input[type="text"] { padding: 6px 8px; font-size: 14px; }
    .muted { color: #666; font-size: 12px; }
    .link { margin: 6px 0 12px; }
    main { max-width: var(--maxw); margin: 0 auto; display: grid; grid-template-columns: 1fr; gap: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f7f7f7; }
    caption { text-align: left; font-weight: 600; margin-bottom: 8px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; }
    }
    canvas { width: 100%; height: 420px; }

    /* Pikaday CSS */
    .pika-single {
      z-index: 9999;
      display: block;
      position: relative;
      color: #333;
      background: #fff;
      border: 1px solid #ccc;
      box-shadow: 0 1px 3px #bbb;
      border-radius: 3px;
    }
    .pika-single.is-hidden {
      display: none;
    }
    .pika-lendar {
      padding: 10px;
    }
    .pika-title {
      text-align: center;
      position: relative;
      margin-bottom: 10px;
      user-select: none;
    }
    .pika-label {
      font-weight: 700;
      font-size: 14px;
    }
    .pika-prev, .pika-next {
      cursor: pointer;
      position: absolute;
      top: 14px;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      font-size: 18px;
      color: #999;
      user-select: none;
    }
    .pika-prev:hover, .pika-next:hover {
      color: #000;
    }
    .pika-prev {
      left: 10px;
    }
    .pika-next {
      right: 10px;
    }
    .pika-table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      user-select: none;
    }
    .pika-table th, .pika-table td {
      width: 14.285714285714286%;
      padding: 5px 0;
      text-align: center;
      cursor: pointer;
    }
    .pika-table th {
      color: #999;
      font-weight: 700;
      font-size: 12px;
    }
    .pika-button {
      border: none;
      background: none;
      color: inherit;
      font: inherit;
      cursor: pointer;
      outline: none;
    }
    .is-disabled {
      color: #ccc !important;
      pointer-events: none;
      cursor: default;
    }
    .is-selected {
      background: #1f77b4;
      color: white;
      border-radius: 3px;
    }
    .is-today {
      color: #d33;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <header>
    <h1>Daily Crypto Mentions</h1>
    <div class="controls">
      <label for="date-picker">Select date:</label>
      <input type="text" id="date-picker" aria-label="Select date" readonly />

      <label for="topn-select">Top N:</label>
      <select id="topn-select" aria-label="Select number of lines">
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="20" selected>20</option>
      </select>

      <span id="meta" class="muted"></span>
    </div>
    <div id="thread-link" class="link"></div>
  </header>

  <main>
    <div class="grid">
      <section>
        <table>
          <caption>Top coins by mentions (selected day)</caption>
          <thead>
            <tr><th style="width:80px">Symbol</th><th>Name</th><th style="width:120px">Mentions</th></tr>
          </thead>
          <tbody id="data-table"><tr><td colspan="3">Loadingâ€¦</td></tr></tbody>
        </table>
      </section>
      <section>
        <canvas id="mentions-chart"></canvas>
      </section>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pikaday/pikaday.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/pikaday/css/pikaday.css" />

  <script>
  (function() {
    'use strict';

    const manifestUrl = 'manifest.json';
    const datePickerEl = document.getElementById('date-picker');
    const topNEl = document.getElementById('topn-select');
    const tbody = document.getElementById('data-table');
    const metaEl = document.getElementById('meta');
    const threadLinkEl = document.getElementById('thread-link');
    const ctx = document.getElementById('mentions-chart').getContext('2d');

    let manifestData = [];
    let dateToFileMap = {};
    let validDateStrs = [];
    let picker = null;
    let chartInstance = null;

    // Fetch JSON with cache-busting
    async function fetchJson(url) {
      const res = await fetch(url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status + ' for ' + url);
      return res.json();
    }

    // Normalize a day's data into a sorted list [{symbol, name, count}]
    function normalizeDayList(dayData) {
      let list = [];
      if (Array.isArray(dayData.results_list) && dayData.results_list.length) {
        list = dayData.results_list.map(r => ({
          symbol: (r.symbol || '').toUpperCase(),
          name: r.name || '',
          count: Number(r.count || 0)
        }));
      } else if (dayData.results && typeof dayData.results === 'object') {
        list = Object.entries(dayData.results).map(([k, v]) => ({
          symbol: (k || '').toUpperCase(),
          name: '',
          count: Number(v || 0)
        }));
      }
      list.sort((a, b) => b.count - a.count);
      return list;
    }

    function renderTable(list, limit = 100) {
      const rows = list.slice(0, limit).map(row => (
        `<tr><td>${row.symbol}</td><td>${row.name || ''}</td><td>${row.count}</td></tr>`
      )).join('');
      tbody.innerHTML = rows || '<tr><td colspan="3">No data</td></tr>';
    }

    function getPalette(n) {
      const base = [
        '#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd',
        '#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf',
        '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f',
        '#edc948','#b07aa1','#ff9da7','#9c755f','#bab0ab'
      ];
      const out = [];
      for (let i = 0; i < n; i++) out.push(base[i % base.length]);
      return out;
    }

    async function loadDayData(filePath, topN) {
      try {
        const dayData = await fetchJson(filePath);
        const list = normalizeDayList(dayData);

        // Thread link + meta
        const updated = dayData.generated_at_utc ? new Date(dayData.generated_at_utc).toISOString().replace('T',' ').replace('Z',' UTC') : '';
        threadLinkEl.innerHTML = dayData.thread_url
          ? `<a href="${dayData.thread_url}" target="_blank" rel="noopener">${dayData.thread_title || 'Thread link'}</a>`
          : (dayData.thread_title || '');
        metaEl.textContent = updated ? `Updated ${updated}` : '';

        // Table
        renderTable(list, 100);

        // Chart for historical trend of the top N symbols from the selected day
        const focusSymbols = list.slice(0, topN).map(r => r.symbol);
        await renderChartUpToDate(focusSymbols);

      } catch(e) {
        tbody.innerHTML = `<tr><td colspan="3" style="color:red;">Error loading data</td></tr>`;
        metaEl.textContent = '';
        threadLinkEl.textContent = '';
        console.error(e);
      }
    }

    async function renderChartUpToDate(focusSymbols) {
      // Gather historical data for these symbols from manifest
      const promises = manifestData.map(async d => {
        const dayData = await fetchJson(d.file);
        const normalized = normalizeDayList(dayData);
        // Map symbol => count for that day
        const map = {};
        normalized.forEach(r => { map[r.symbol] = r.count; });
        return { date: d.date, map };
      });

      const results = await Promise.all(promises);

      const labels = results.map(r => r.date);
      const datasets = [];

      const palette = getPalette(focusSymbols.length);

      focusSymbols.forEach((sym, idx) => {
        const data = results.map(r => r.map[sym] || 0);
        datasets.push({
          label: sym,
          data,
          fill: false,
          borderColor: palette[idx],
          backgroundColor: palette[idx],
          tension: 0.1,
          pointRadius: 2,
          borderWidth: 2,
          spanGaps: true,
        });
      });

      if (chartInstance) chartInstance.destroy();

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          interaction: {
            mode: 'nearest',
            intersect: false
          },
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              enabled: true,
              mode: 'index',
              intersect: false,
              callbacks: {
                title: ctx => ctx[0].label,
                label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y}`,
              }
            }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Mentions' } },
            x: { title: { display: true, text: 'Date' } }
          }
        }
      });
    }

    // Format date as local YYYY-MM-DD (no timezone shift)
    function formatLocalDate(d) {
      const y = d.getFullYear();
      const m = (d.getMonth() + 1).toString().padStart(2, '0');
      const day = d.getDate().toString().padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    // Initialize picker with valid dates only
    function setupDatePicker() {
      picker = new Pikaday({
        field: datePickerEl,
        format: 'YYYY-MM-DD',
        firstDay: 1,
        toString(date) {
          return formatLocalDate(date);
        },
        disableDayFn(date) {
          const iso = formatLocalDate(date);
          return !validDateStrs.includes(iso);
        },
        onSelect(date) {
          const iso = formatLocalDate(date);
          const file = dateToFileMap[iso];
          if (file) loadDayData(file, parseInt(topNEl.value, 10));
        }
      });

      // Set to latest valid date
      if (validDateStrs.length) {
        const lastDateStr = validDateStrs[validDateStrs.length - 1];
        const [y, m, d] = lastDateStr.split('-').map(Number);
        picker.setDate(new Date(y, m -1, d));
      }
    }

    async function init() {
      try {
        manifestData = await fetchJson(manifestUrl);
        // Sort manifest by date ascending
        manifestData.sort((a,b) => a.date.localeCompare(b.date));

        dateToFileMap = {};
        validDateStrs = [];

        manifestData.forEach(d => {
          if (d.date && d.file) {
            dateToFileMap[d.date] = d.file;
            validDateStrs.push(d.date);
          }
        });

        setupDatePicker();

        // Load initial data for latest date
        const latestDate = validDateStrs[validDateStrs.length - 1];
        if (latestDate) {
          const file = dateToFileMap[latestDate];
          loadDayData(file, parseInt(topNEl.value, 10));
        }

      } catch(e) {
        tbody.innerHTML = `<tr><td colspan="3" style="color:red;">Failed to load manifest</td></tr>`;
        console.error(e);
      }
    }

    topNEl.addEventListener('change', () => {
      if (!picker) return;
      const date = picker.getDate();
      if (!date) return;
      const iso = formatLocalDate(date);
      const file = dateToFileMap[iso];
      if (file) loadDayData(file, parseInt(topNEl.value, 10));
    });

    init();

  })();
  </script>
</body>
</html>
